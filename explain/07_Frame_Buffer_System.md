# Frame_Buffer 시스템 - 듀얼 포트 메모리

## 📋 개요
Frame_Buffer는 AI Fourcut 프로젝트의 핵심 메모리 시스템으로, 카메라 입력과 VGA 출력 간의 중간 버퍼 역할을 합니다.

## 🏗️ 시스템 구조

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   카메라        │    │   Frame_Buffer  │    │   VGA 출력      │
│   (Write)       │───▶│   (Dual-Port    │───▶│   (Read)        │
│   ov7670_pclk   │    │    Memory)      │    │   vga_pclk      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🔧 Frame_Buffer 모듈 분석

### **인터페이스 정의**
```systemverilog
module Frame_Buffer (
    // Write side (카메라 입력)
    input  logic        wclk,      // Write Clock
    input  logic        we,        // Write Enable
    input  logic [16:0] wAddr,     // Write Address
    input  logic [15:0] wData,     // Write Data
    
    // Read side (VGA 출력)
    input  logic        rclk,      // Read Clock
    input  logic        oe,        // Output Enable
    input  logic [16:0] rAddr,     // Read Address
    output logic [15:0] rData      // Read Data
);
```

### **메모리 구조**
```systemverilog
// 320×240 = 76,800 픽셀
logic [15:0] mem[0:(320*240-1)];

// 주소 범위: 0 ~ 76,799 (17비트)
// 데이터 폭: 16비트 (RGB565)
// 총 용량: 153,600 바이트 (150KB)
```

## ⚡ 듀얼 포트 메모리 특성

### **독립적인 클럭 도메인**
```systemverilog
// Write 도메인 (카메라)
always_ff @(posedge wclk) begin
    if (we) begin
        mem[wAddr] <= wData;
    end
end

// Read 도메인 (VGA)
always_ff @(posedge rclk) begin
    if (oe) begin
        rData <= mem[rAddr];
    end
end
```

### **동시 접근 가능**
- **쓰기**: 카메라가 새로운 프레임을 저장
- **읽기**: VGA가 이전 프레임을 출력
- **충돌 없음**: 서로 다른 주소 접근

## 📊 메모리 매핑

### **주소 계산**
```systemverilog
// 1차원 주소 → 2차원 좌표
logic [8:0] x = wAddr % 320;  // 0~319
logic [7:0] y = wAddr / 320;  // 0~239

// 2차원 좌표 → 1차원 주소
logic [16:0] addr = y * 320 + x;
```

### **메모리 레이아웃**
```
메모리 주소: 0x0000 ~ 0x12BFF (76,800 바이트)
┌─────────────────────────────────────────┐
│ 0x0000: (0,0)   (1,0)   (2,0)   ...   │
│ 0x0140: (0,1)   (1,1)   (2,1)   ...   │
│ 0x0280: (0,2)   (1,2)   (2,2)   ...   │
│ ...                                    │
│ 0x12B40: (0,239) (1,239) (2,239) ...  │
└─────────────────────────────────────────┘
```

## 🔄 데이터 흐름

### **카메라 → 메모리**
```
OV7670 → OV7670_MemController → Frame_Buffer (Write)
```

### **메모리 → VGA**
```
Frame_Buffer (Read) → VGA_MemController → VGA_Decoder
```

### **이미지 처리**
```
카메라 데이터 → Filter_Top → 필터 적용 → Frame_Buffer
```

## ⚡ 성능 특성

### **메모리 대역폭**
- **쓰기 속도**: 320×240×30fps = 2.3M 픽셀/초
- **읽기 속도**: 640×480×60fps = 18.4M 픽셀/초
- **총 대역폭**: 20.7M 픽셀/초

### **지연 시간**
- **쓰기 지연**: 1클럭 (카메라 클럭)
- **읽기 지연**: 1클럭 (VGA 클럭)
- **전체 지연**: 2클럭 (파이프라인)

## 🔧 최적화 기법

### **1. 메모리 효율성**
```systemverilog
// RGB565 포맷 사용 (16비트)
// RGB888 대비 33% 메모리 절약
// 320×240×2 = 153,600 바이트
```

### **2. 파이프라인 처리**
```systemverilog
// 쓰기와 읽기 동시 처리
// 프레임 지연 최소화
// 실시간 처리 가능
```

### **3. 클럭 도메인 분리**
```systemverilog
// 카메라 클럭: ov7670_pclk
// VGA 클럭: vga_pclk
// 독립적인 타이밍
```

## 🎯 설계 원리

### **1. 버퍼링**
- **목적**: 카메라와 VGA 간의 속도 차이 해결
- **방법**: 중간 버퍼 사용
- **효과**: 안정적인 데이터 전송

### **2. 듀얼 포트**
- **목적**: 동시 읽기/쓰기
- **방법**: 독립적인 포트
- **효과**: 높은 처리량

### **3. 실시간 처리**
- **목적**: 지연 시간 최소화
- **방법**: 파이프라인 구조
- **효과**: 실시간 응답

## 🔍 메모리 접근 패턴

### **쓰기 패턴 (카메라)**
```
주소: 0 → 1 → 2 → ... → 76799
시간: 순차적, 연속적
속도: 30fps
```

### **읽기 패턴 (VGA)**
```
주소: 0 → 1 → 2 → ... → 76799
시간: 순차적, 연속적
속도: 60fps
```

### **동시 접근**
```
쓰기: 프레임 N 저장
읽기: 프레임 N-1 출력
충돌: 없음 (서로 다른 프레임)
```

## 🎯 학습 포인트

1. **듀얼 포트 메모리**: 동시 읽기/쓰기
2. **클럭 도메인**: 서로 다른 클럭 간 데이터 전송
3. **버퍼링**: 속도 차이 해결
4. **메모리 매핑**: 2D 좌표 → 1D 주소
5. **실시간 처리**: 파이프라인 구조

## 🔧 구현 도전과제

### **1. 메모리 크기**
- **제약**: FPGA 내부 메모리 한계
- **해결**: RGB565 포맷 사용
- **최적화**: 압축 기법 적용

### **2. 클럭 도메인**
- **제약**: 서로 다른 클럭 도메인
- **해결**: 듀얼 포트 메모리
- **최적화**: 클럭 도메인 분리

### **3. 실시간 처리**
- **제약**: 지연 시간 최소화
- **해결**: 파이프라인 구조
- **최적화**: 병렬 처리

## 📝 다음 단계
- `08_Memory_Controllers.md`: 메모리 컨트롤러 분석
- `09_SCCB_Protocol.md`: 카메라 통신 프로토콜
- `10_UART_Communication.md`: UART 통신 시스템
